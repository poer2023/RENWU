# TaskWall v2.0 部署指南

## 🚀 快速开始

### 方式一：自动启动脚本（推荐）

```bash
# 确保在项目根目录
cd /Users/hao/project/RENWU

# 运行自动启动脚本
./start.sh
```

脚本会自动：
- 创建Python虚拟环境
- 安装所有依赖
- 启动后端API服务器 (端口8000)
- 启动前端开发服务器 (端口5173)

### 方式二：手动部署

#### 1. 环境准备

**系统要求**:
- Python 3.8+
- Node.js 16+
- npm 或 yarn

**依赖安装**:
```bash
# 后端依赖
cd backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt

# 前端依赖
cd ../frontend
npm install
```

#### 2. 启动服务

**后端服务**:
```bash
cd backend
source venv/bin/activate
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**前端服务**:
```bash
cd frontend
npm run dev
```

### 方式三：Docker部署

```bash
# 使用Docker Compose
docker-compose up -d --build

# 访问应用
# 前端: http://localhost:3000
# 后端: http://localhost:8000
```

## 🔧 配置说明

### 1. 环境变量配置

创建 `.env` 文件：

```bash
# 后端配置
DATABASE_URL=sqlite:///./data/taskwall.db
GEMINI_API_KEY=your_gemini_api_key_here

# 前端配置 (frontend/.env)
VITE_API_BASE_URL=http://localhost:8000
```

### 2. Gemini API 密钥配置

**获取API密钥**:
1. 访问 [Google AI Studio](https://makersuite.google.com/app/apikey)
2. 创建新的API密钥
3. 在应用设置中输入密钥

**设置方式**:
- 通过Web界面：设置 → AI设置 → Gemini API Key
- 通过环境变量：`GEMINI_API_KEY=your_key`
- 通过配置文件：在数据库settings表中保存

### 3. 数据库配置

**默认配置** (SQLite):
```python
DATABASE_URL = "sqlite:///./data/taskwall.db"
```

**PostgreSQL配置** (可选):
```python
DATABASE_URL = "postgresql://user:password@localhost/taskwall"
```

**MySQL配置** (可选):
```python
DATABASE_URL = "mysql://user:password@localhost/taskwall"
```

## 📁 目录结构

```
TaskWall/
├── backend/
│   ├── app/
│   ├── data/              # SQLite数据库文件
│   └── requirements.txt
├── frontend/
│   ├── src/
│   ├── dist/              # 构建输出目录
│   └── package.json
├── data/                  # 共享数据目录
│   ├── taskwall.db        # 主数据库
│   └── backup/            # 自动备份文件
├── docker-compose.yml     # Docker编排文件
└── start.sh              # 启动脚本
```

## 🌐 生产环境部署

### 1. 前端构建

```bash
cd frontend
npm run build

# 输出目录: dist/
# 可部署到任何静态文件服务器
```

### 2. Nginx配置

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    # 前端静态文件
    location / {
        root /path/to/taskwall/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # 后端API代理
    location /api {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 3. 后端生产配置

**使用Gunicorn**:
```bash
pip install gunicorn
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

**使用PM2** (Node.js进程管理器):
```bash
npm install -g pm2
pm2 start "gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000" --name taskwall-api
```

### 4. 系统服务配置

**创建systemd服务** (`/etc/systemd/system/taskwall.service`):
```ini
[Unit]
Description=TaskWall API Server
After=network.target

[Service]
Type=exec
User=taskwall
Group=taskwall
WorkingDirectory=/opt/taskwall/backend
Environment=PATH=/opt/taskwall/backend/venv/bin
ExecStart=/opt/taskwall/backend/venv/bin/gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
Restart=always

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl enable taskwall
sudo systemctl start taskwall
sudo systemctl status taskwall
```

## 🔒 安全配置

### 1. HTTPS配置

**Let's Encrypt SSL证书**:
```bash
sudo certbot --nginx -d yourdomain.com
```

**SSL配置更新**:
```nginx
server {
    listen 443 ssl http2;
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    
    # 其他配置...
}
```

### 2. 防火墙配置

```bash
# 开放必要端口
sudo ufw allow 22   # SSH
sudo ufw allow 80   # HTTP
sudo ufw allow 443  # HTTPS
sudo ufw enable
```

### 3. 安全头配置

```nginx
# 安全头
add_header X-Frame-Options DENY;
add_header X-Content-Type-Options nosniff;
add_header X-XSS-Protection "1; mode=block";
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";
```

## 📊 监控配置

### 1. 应用监控

**使用Prometheus + Grafana**:
```bash
# 安装监控依赖
pip install prometheus-client

# 添加监控端点到FastAPI应用
from prometheus_client import generate_latest, Counter, Histogram
```

### 2. 日志配置

**配置Python日志**:
```python
import logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('/var/log/taskwall/app.log'),
        logging.StreamHandler()
    ]
)
```

### 3. 健康检查

**添加健康检查端点**:
```python
@app.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "timestamp": datetime.utcnow(),
        "version": "2.0.0"
    }
```

## 🔄 备份与恢复

### 1. 自动备份配置

**数据库备份**:
```bash
# 创建备份脚本 (/opt/taskwall/backup.sh)
#!/bin/bash
BACKUP_DIR="/opt/taskwall/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# 数据库备份
cp /opt/taskwall/data/taskwall.db $BACKUP_DIR/taskwall_$DATE.db

# 清理30天前的备份
find $BACKUP_DIR -name "taskwall_*.db" -mtime +30 -delete
```

**定时备份任务**:
```bash
# 添加到crontab
0 2 * * * /opt/taskwall/backup.sh
```

### 2. 恢复操作

```bash
# 停止服务
sudo systemctl stop taskwall

# 恢复数据库
cp /opt/taskwall/backups/taskwall_backup.db /opt/taskwall/data/taskwall.db

# 重启服务
sudo systemctl start taskwall
```

## 🐛 故障排除

### 1. 常见问题

**端口占用**:
```bash
# 检查端口占用
lsof -i :8000
lsof -i :5173

# 终止占用进程
kill -9 <PID>
```

**权限问题**:
```bash
# 修复文件权限
sudo chown -R taskwall:taskwall /opt/taskwall
sudo chmod +x /opt/taskwall/start.sh
```

**依赖安装问题**:
```bash
# Python依赖问题
pip install --upgrade pip
pip install -r requirements.txt --force-reinstall

# Node.js依赖问题
rm -rf node_modules package-lock.json
npm install
```

### 2. 日志检查

```bash
# 应用日志
tail -f /var/log/taskwall/app.log

# 系统服务日志
journalctl -u taskwall -f

# Nginx日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

### 3. 性能调优

**数据库优化**:
```sql
-- 创建索引提升查询性能
CREATE INDEX idx_tasks_updated_at ON task(updated_at);
CREATE INDEX idx_tasks_module_id ON task(module_id);
CREATE INDEX idx_tasks_urgency ON task(urgency);
```

**缓存配置**:
```python
# 使用Redis缓存AI响应
import redis
redis_client = redis.Redis(host='localhost', port=6379, db=0)
```

## 🔧 自定义配置

### 1. 功能开关

```python
# 在settings表中配置功能开关
FEATURE_FLAGS = {
    "enable_ai_assistant": True,
    "enable_similarity_detection": True,
    "enable_risk_radar": True,
    "enable_theme_islands": True,
    "enable_workload_analysis": True
}
```

### 2. AI模型配置

```python
# 支持切换不同的AI模型
AI_CONFIG = {
    "provider": "gemini",  # gemini, openai, claude
    "model": "gemini-pro",
    "temperature": 0.7,
    "max_tokens": 2048
}
```

### 3. 界面定制

```css
/* 自定义主题色彩 */
:root {
  --primary-color: #1890ff;
  --success-color: #52c41a;
  --warning-color: #faad14;
  --error-color: #ff4d4f;
}
```

## 📞 技术支持

- **文档**: 参考项目README和技术文档
- **日志**: 检查应用和系统日志
- **监控**: 使用监控工具排查性能问题
- **社区**: 搜索相关技术社区获取帮助

---

**TaskWall v2.0** 部署完成后，您将拥有一个功能完整的AI增强型任务管理系统！ 🎉