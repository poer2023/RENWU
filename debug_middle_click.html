<!DOCTYPE html>
<html>
<head>
    <title>中键拖动调试页面</title>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        .debug-info {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #007bff;
        }
        .test-area {
            width: 800px;
            height: 400px;
            border: 3px solid #333;
            background: linear-gradient(45deg, #f9f9f9 25%, transparent 25%),
                        linear-gradient(-45deg, #f9f9f9 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #f9f9f9 75%),
                        linear-gradient(-45deg, transparent 75%, #f9f9f9 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            position: relative;
            cursor: grab;
            margin-bottom: 20px;
        }
        .test-area:active {
            cursor: grabbing;
        }
        .log-area {
            height: 300px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid #ffeaa7;
        }
        .clear-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .iframe-container {
            border: 2px solid #28a745;
            border-radius: 8px;
            overflow: hidden;
            height: 500px;
            margin-top: 20px;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="debug-info">
        <h2>🔍 中键拖动功能深度调试</h2>
        <p><strong>测试目标:</strong> 确定中键拖动功能失效的根本原因</p>
        <p><strong>浏览器:</strong> <span id="browser-info"></span></p>
        <p><strong>操作系统:</strong> <span id="os-info"></span></p>
        <p><strong>时间戳:</strong> <span id="timestamp"></span></p>
    </div>

    <div class="status">
        <h3>📋 测试步骤:</h3>
        <ol>
            <li><strong>步骤1:</strong> 在下方灰色区域按住鼠标中键拖动</li>
            <li><strong>步骤2:</strong> 观察控制台日志输出</li>
            <li><strong>步骤3:</strong> 在下方TaskWall应用中测试中键拖动</li>
            <li><strong>步骤4:</strong> 对比两个测试结果</li>
        </ol>
    </div>

    <h3>🧪 基础中键拖动测试</h3>
    <div class="test-area" id="testArea">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    background: rgba(0,123,255,0.1); padding: 20px; border-radius: 10px; 
                    border: 2px dashed #007bff; text-align: center;">
            <h4>🎯 测试区域</h4>
            <p>在这里按住鼠标中键拖动</p>
            <p>应该能看到详细的事件日志</p>
        </div>
    </div>

    <button class="clear-btn" onclick="clearLog()">🗑️ 清除日志</button>
    <div class="log-area" id="logArea"></div>

    <h3>🎮 TaskWall应用测试</h3>
    <div class="iframe-container">
        <iframe src="http://localhost:3000" id="taskwallFrame"></iframe>
    </div>

    <script>
        let isPanning = false;
        let startX = 0;
        let startY = 0;
        let currentX = 0;
        let currentY = 0;
        
        const testArea = document.getElementById('testArea');
        const logArea = document.getElementById('logArea');
        
        // 初始化页面信息
        document.getElementById('browser-info').textContent = navigator.userAgent;
        document.getElementById('os-info').textContent = navigator.platform;
        document.getElementById('timestamp').textContent = new Date().toLocaleString();
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : 
                         type === 'success' ? '#51cf66' : 
                         type === 'warning' ? '#ffd43b' : '#74c0fc';
            
            logArea.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLog() {
            logArea.innerHTML = '';
            addLog('🧹 日志已清除', 'info');
        }
        
        // 初始化日志
        addLog('🚀 调试页面初始化完成');
        addLog('🖱️ 请在上方测试区域使用鼠标中键拖动');
        
        // === 核心事件监听 ===
        
        // 1. mousedown 事件
        testArea.addEventListener('mousedown', function(event) {
            addLog(`🎯 mousedown 事件: button=${event.button}, 位置=(${event.clientX}, ${event.clientY})`, 'info');
            
            if (event.button === 1) { // 中键
                addLog('🚀 中键按下 - 开始拖动流程', 'success');
                event.preventDefault();
                event.stopPropagation();
                
                isPanning = true;
                startX = event.clientX;
                startY = event.clientY;
                currentX = 0;
                currentY = 0;
                
                testArea.style.cursor = 'grabbing';
                document.body.style.userSelect = 'none';
                
                // 绑定全局事件
                document.addEventListener('mousemove', handleMouseMove, { passive: false, capture: true });
                document.addEventListener('mouseup', handleMouseUp, { passive: false, capture: true, once: true });
                
                addLog('✅ 事件监听器已绑定', 'success');
            } else {
                addLog(`ℹ️ 其他按键按下: button=${event.button}`, 'warning');
            }
        });
        
        // 2. auxclick 事件
        testArea.addEventListener('auxclick', function(event) {
            addLog(`🎯 auxclick 事件: button=${event.button}`, 'info');
            
            if (event.button === 1) {
                addLog('🚫 阻止中键默认行为', 'warning');
                event.preventDefault();
                event.stopPropagation();
            }
        });
        
        // 3. contextmenu 事件
        testArea.addEventListener('contextmenu', function(event) {
            addLog('🎯 contextmenu 事件触发', 'warning');
            event.preventDefault();
        });
        
        // 4. mousemove 处理函数
        function handleMouseMove(event) {
            if (!isPanning) return;
            
            event.preventDefault();
            
            const deltaX = event.clientX - startX;
            const deltaY = event.clientY - startY;
            
            currentX += deltaX * 0.1; // 模拟画布移动
            currentY += deltaY * 0.1;
            
            // 更新视觉反馈
            testArea.style.backgroundPosition = `${currentX}px ${currentY}px`;
            
            if (Math.random() < 0.3) { // 减少日志频率
                addLog(`📊 拖动中: 位移=(${deltaX}, ${deltaY}), 累计=(${currentX.toFixed(1)}, ${currentY.toFixed(1)})`, 'info');
            }
        }
        
        // 5. mouseup 处理函数
        function handleMouseUp(event) {
            if (!isPanning) return;
            
            addLog('🛑 中键拖动结束', 'success');
            addLog(`📈 最终位移: (${currentX.toFixed(1)}, ${currentY.toFixed(1)})`, 'success');
            
            isPanning = false;
            testArea.style.cursor = 'grab';
            document.body.style.userSelect = '';
            
            // 移除事件监听器
            document.removeEventListener('mousemove', handleMouseMove, { capture: true });
            
            addLog('✅ 事件监听器已清理', 'success');
        }
        
        // === 额外的调试信息 ===
        
        // 检测鼠标能力
        addLog(`🖱️ 鼠标按键支持: ${navigator.maxTouchPoints > 0 ? '触摸设备' : '鼠标设备'}`, 'info');
        
        // 检测事件支持
        const supportsAuxClick = 'onauxclick' in testArea;
        addLog(`🔧 auxclick 事件支持: ${supportsAuxClick ? '✅' : '❌'}`, supportsAuxClick ? 'success' : 'error');
        
        // 检测浏览器特性
        const isChrome = navigator.userAgent.includes('Chrome');
        const isFirefox = navigator.userAgent.includes('Firefox');
        const isSafari = navigator.userAgent.includes('Safari') && !isChrome;
        
        addLog(`🌐 浏览器类型: ${isChrome ? 'Chrome' : isFirefox ? 'Firefox' : isSafari ? 'Safari' : '其他'}`, 'info');
        
        // 监听iframe加载
        const iframe = document.getElementById('taskwallFrame');
        iframe.onload = function() {
            addLog('🎮 TaskWall应用已加载完成', 'success');
            addLog('💡 现在可以在TaskWall应用中测试中键拖动功能', 'info');
        };
        
        iframe.onerror = function() {
            addLog('❌ TaskWall应用加载失败', 'error');
        };
        
        // 全局错误捕获
        window.addEventListener('error', function(event) {
            addLog(`💥 JavaScript错误: ${event.message}`, 'error');
        });
        
        addLog('🔍 所有事件监听器已设置完成', 'success');
        addLog('📋 请开始测试...', 'info');
    </script>
</body>
</html>